<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GoManager â€” Go Binary Repository</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      font-size: 13px;
      background: #1b1d1e;
      color: #ccc;
      line-height: 1.5;
    }
    a { color: #07b; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container {
      max-width: 1500px;
      margin: 0 auto;
      padding: 15px;
    }

    /* Header */
    .site-header {
      background: #222;
      border-bottom: 1px solid #333;
      padding: 10px 0;
      margin-bottom: 15px;
    }
    .site-header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 0;
      padding-bottom: 0;
    }
    .site-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: #eee;
    }
    .site-header h1 span { color: #07b; }
    .site-header .subtitle {
      color: #888;
      font-size: 12px;
    }

    /* Search Criteria box */
    .search-criteria {
      background: #222;
      border: 1px solid #333;
      padding: 12px 15px;
      margin-bottom: 15px;
    }
    .search-criteria h2 {
      font-size: 14px;
      color: #eee;
      margin-bottom: 10px;
      font-weight: 600;
    }
    .search-row {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .search-field { display: flex; flex-direction: column; gap: 3px; }
    .search-field label { font-size: 11px; color: #999; }
    .search-field input,
    .search-field select {
      background: #1b1d1e;
      color: #ccc;
      border: 1px solid #444;
      padding: 4px 8px;
      font-size: 13px;
      font-family: inherit;
    }
    .search-field input { width: 260px; }
    .search-field select { min-width: 100px; }
    .search-field input:focus,
    .search-field select:focus { border-color: #07b; outline: none; }
    .search-btn {
      background: #333;
      color: #ccc;
      border: 1px solid #444;
      padding: 4px 16px;
      font-size: 13px;
      cursor: pointer;
      font-family: inherit;
    }
    .search-btn:hover { background: #444; }
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: #999;
      cursor: pointer;
      user-select: none;
      padding-bottom: 2px;
    }
    .toggle-label input { cursor: pointer; }

    /* Results info */
    .results-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      color: #999;
    }
    .results-info .stats-inline span { margin-left: 10px; }
    .results-info .confirmed-count { color: #6a2; }
    .results-info .failed-count { color: #c44; }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead { background: #222; }
    th {
      padding: 6px 10px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: #aaa;
      border-bottom: 1px solid #444;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
    }
    th:hover { color: #07b; }
    th .arrow { font-size: 9px; margin-left: 3px; opacity: 0.4; }
    th.sorted .arrow { opacity: 1; color: #07b; }
    td {
      padding: 4px 10px;
      border-bottom: 1px solid #2a2c2d;
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
    tr:hover td { background: #252729; }
    /* Column widths */
    .col-name { width: 13%; }
    .col-version { width: 8%; }
    .col-stars { width: 6%; text-align: right; }
    .col-status { width: 7%; }
    .col-desc { width: 30%; }
    .col-install { width: 36%; }

    td.stars-cell { text-align: right; font-variant-numeric: tabular-nums; }
    td.name-cell a { color: #07b; }
    td.desc-cell { color: #999; }

    /* Status styles */
    .status-confirmed { color: #6a2; }
    .status-failed { color: #c44; }
    .status-unknown { color: #666; }

    /* Install column */
    td.install-cell {
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 12px;
      white-space: nowrap;
    }
    td.install-cell .flags {
      color: #b87;
      margin-right: 2px;
    }
    td.install-cell .cmd { color: #aaa; }
    .copy-btn {
      background: #333;
      border: 1px solid #555;
      color: #888;
      padding: 1px 8px;
      margin-right: 6px;
      cursor: pointer;
      font-size: 11px;
      font-family: inherit;
      vertical-align: middle;
    }
    .copy-btn:hover { background: #444; color: #eee; }
    .copy-btn.copied { color: #6a2; border-color: #6a2; }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .loading {
      text-align: center;
      padding: 60px;
      color: #666;
    }

    @media (max-width: 900px) {
      .search-row { flex-direction: column; }
      .search-field input { width: 100%; }
      .col-desc { display: none; }
      .col-name { width: 18%; }
      .col-version { width: 10%; }
      .col-stars { width: 8%; }
      .col-status { width: 10%; }
      .col-install { width: 54%; }
    }
  </style>
</head>

<body>
  <div class="site-header">
    <div class="container">
      <div>
        <h1>Go<span>Manager</span></h1>
      </div>
      <div class="subtitle">Go binary repository</div>
    </div>
  </div>

  <div class="container">
    <div class="search-criteria">
      <h2>Search Criteria</h2>
      <div class="search-row">
        <div class="search-field">
          <label>Keywords</label>
          <input type="text" id="search" placeholder="Search packages..." />
        </div>
        <div class="search-field">
          <label>Status</label>
          <select id="statusFilter">
            <option value="all">All</option>
            <option value="confirmed">Confirmed</option>
            <option value="failed">Failed</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        <div class="search-field">
          <label>Sort by</label>
          <select id="sortSelect">
            <option value="stars">Stars</option>
            <option value="name">Name</option>
            <option value="build_status">Status</option>
            <option value="version">Version</option>
          </select>
        </div>
        <div class="search-field">
          <label>Per page</label>
          <select id="perPage">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="250">250</option>
            <option value="0">All</option>
          </select>
        </div>
        <label class="toggle-label">
          <input type="checkbox" id="showAll" /> Show internal commands
        </label>
      </div>
    </div>

    <div class="results-info" id="resultsInfo"></div>
    <div id="output"><div class="loading">Loading database...</div></div>
    <div class="results-info" id="paginationBottom"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    let db = null;
    let allRows = [];
    let sortCol = "stars";
    let sortDir = "desc";
    let currentPage = 1;

    async function init() {
      try {
        const SQL = await initSqlJs({
          locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`
        });
        const response = await fetch("./database.db");
        if (!response.ok) throw new Error("database.db not found");
        const buffer = await response.arrayBuffer();
        db = new SQL.Database(new Uint8Array(buffer));
        loadData();
      } catch (err) {
        document.getElementById("output").innerHTML =
          `<div class="empty-state">Failed to load database: ${err.message}</div>`;
      }
    }

    function loadData() {
      const result = db.exec(
        `SELECT id, name, package, version, description, repo_url, stars,
                COALESCE(is_primary, 1) as is_primary,
                build_status, build_flags, build_error, last_verified
         FROM binaries ORDER BY stars DESC`
      );
      if (!result.length) {
        allRows = [];
      } else {
        const cols = result[0].columns;
        allRows = result[0].values.map(row => {
          const obj = {};
          cols.forEach((c, i) => obj[c] = row[i]);
          return obj;
        });
      }
      renderAll();
    }

    function getFilteredRows() {
      const query = document.getElementById("search").value.toLowerCase();
      const showInternal = document.getElementById("showAll").checked;
      const statusFilter = document.getElementById("statusFilter").value;
      return allRows.filter(r => {
        if (!showInternal && !r.is_primary) return false;
        if (statusFilter !== "all") {
          if (statusFilter === "unknown" && r.build_status !== "unknown" && r.build_status !== "pending") return false;
          if (statusFilter !== "unknown" && r.build_status !== statusFilter) return false;
        }
        if (query) {
          const hay = `${r.name} ${r.package} ${r.description || ""}`.toLowerCase();
          return hay.includes(query);
        }
        return true;
      });
    }

    function sortRows(rows) {
      return rows.slice().sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (typeof va === "string") va = (va || "").toLowerCase();
        if (typeof vb === "string") vb = (vb || "").toLowerCase();
        if (va == null) va = "";
        if (vb == null) vb = "";
        let cmp = 0;
        if (typeof va === "number" && typeof vb === "number") cmp = va - vb;
        else cmp = String(va).localeCompare(String(vb));
        return sortDir === "asc" ? cmp : -cmp;
      });
    }

    function getPerPage() {
      return parseInt(document.getElementById("perPage").value) || 0;
    }

    function renderAll() {
      const filtered = sortRows(getFilteredRows());
      const total = filtered.length;
      const perPage = getPerPage();
      const totalPages = perPage > 0 ? Math.ceil(total / perPage) : 1;
      if (currentPage > totalPages) currentPage = totalPages || 1;

      const start = perPage > 0 ? (currentPage - 1) * perPage : 0;
      const pageRows = perPage > 0 ? filtered.slice(start, start + perPage) : filtered;

      // Stats
      const confirmed = filtered.filter(r => r.build_status === "confirmed").length;
      const failed = filtered.filter(r => r.build_status === "failed").length;

      const pageInfo = perPage > 0
        ? `${total} packages found. Page ${currentPage} of ${totalPages}.`
        : `${total} packages found.`;

      document.getElementById("resultsInfo").innerHTML =
        `<div>${pageInfo}</div>` +
        `<div class="stats-inline">` +
          `<span class="confirmed-count">${confirmed} confirmed</span>` +
          `<span class="failed-count">${failed} failed</span>` +
        `</div>`;

      // Pagination
      let paginationHtml = "";
      if (perPage > 0 && totalPages > 1) {
        paginationHtml = renderPagination(currentPage, totalPages);
      }
      document.getElementById("paginationBottom").innerHTML = paginationHtml;

      // Table
      if (!pageRows.length) {
        document.getElementById("output").innerHTML =
          `<div class="empty-state">No packages found.</div>`;
        return;
      }

      const columns = [
        { key: "name", label: "Name", cls: "col-name" },
        { key: "version", label: "Version", cls: "col-version" },
        { key: "stars", label: "Stars", cls: "col-stars" },
        { key: "build_status", label: "Status", cls: "col-status" },
        { key: "description", label: "Description", cls: "col-desc" },
        { key: "package", label: "Install", cls: "col-install", nosort: true },
      ];

      let html = "<table><thead><tr>";
      for (const col of columns) {
        const sorted = sortCol === col.key;
        const arrow = sorted ? (sortDir === "asc" ? "&#9650;" : "&#9660;") : "";
        const sortable = !col.nosort;
        html += `<th class="${col.cls} ${sorted ? "sorted" : ""}" ${sortable ? `data-col="${col.key}"` : ""}>${col.label}${arrow ? `<span class="arrow">${arrow}</span>` : ""}</th>`;
      }
      html += "</tr></thead><tbody>";

      for (const r of pageRows) {
        const statusCls = r.build_status === "confirmed" ? "status-confirmed"
          : r.build_status === "failed" ? "status-failed" : "status-unknown";
        const flags = parseFlags(r.build_flags);
        const installPkg = `go install ${r.package}@${r.version || "latest"}`;
        const fullCmd = flags ? flags + " " + installPkg : installPkg;

        html += "<tr>";
        html += `<td class="name-cell col-name"><a href="${r.repo_url || "#"}" target="_blank" rel="noopener">${esc(r.name)}</a></td>`;
        html += `<td class="col-version">${esc(r.version || "latest")}</td>`;
        html += `<td class="stars-cell col-stars">${(r.stars || 0).toLocaleString()}</td>`;
        html += `<td class="col-status ${statusCls}">${r.build_status || "unknown"}</td>`;
        html += `<td class="desc-cell col-desc" title="${esc(r.description || "")}">${esc(r.description || "")}</td>`;
        html += `<td class="install-cell col-install">`;
        html += `<button class="copy-btn" onclick="copyCmd(this,'${escAttr(fullCmd)}')">Copy</button> `;
        if (flags) html += `<span class="flags">${esc(flags)}</span> `;
        html += `<span class="cmd">${esc(installPkg)}</span>`;
        html += `</td>`;
        html += "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("output").innerHTML = html;
    }

    function renderPagination(current, total) {
      let html = '<div style="margin-top:8px;font-size:12px;">';
      const maxVisible = 7;
      const pages = [];

      pages.push(1);
      let start = Math.max(2, current - 2);
      let end = Math.min(total - 1, current + 2);
      if (start > 2) pages.push("...");
      for (let i = start; i <= end; i++) pages.push(i);
      if (end < total - 1) pages.push("...");
      if (total > 1) pages.push(total);

      if (current > 1) html += `<a href="#" onclick="goPage(${current-1});return false">Prev</a> `;
      for (const p of pages) {
        if (p === "...") { html += ".. "; continue; }
        if (p === current) html += `<b style="color:#eee">${p}</b> `;
        else html += `<a href="#" onclick="goPage(${p});return false">${p}</a> `;
      }
      if (current < total) html += `<a href="#" onclick="goPage(${current+1});return false">Next</a>`;
      html += "</div>";
      return html;
    }

    function goPage(n) { currentPage = n; renderAll(); window.scrollTo(0, 0); }

    function parseFlags(flagsJson) {
      if (!flagsJson || flagsJson === "{}") return "";
      try {
        const obj = JSON.parse(flagsJson);
        return Object.entries(obj).map(([k, v]) => `${k}=${v}`).join(" ");
      } catch { return ""; }
    }

    function esc(str) {
      if (!str) return "";
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function escAttr(str) {
      return esc(str).replace(/'/g, "\\'");
    }

    function copyCmd(btn, cmd) {
      navigator.clipboard.writeText(cmd).then(() => {
        btn.textContent = "Copied!";
        setTimeout(() => { btn.textContent = "Copy"; }, 1200);
      });
    }

    // Event listeners
    document.getElementById("search").addEventListener("input", () => { currentPage = 1; renderAll(); });
    document.getElementById("statusFilter").addEventListener("change", () => { currentPage = 1; renderAll(); });
    document.getElementById("showAll").addEventListener("change", () => { currentPage = 1; renderAll(); });
    document.getElementById("perPage").addEventListener("change", () => { currentPage = 1; renderAll(); });
    document.getElementById("sortSelect").addEventListener("change", e => {
      sortCol = e.target.value;
      sortDir = sortCol === "stars" ? "desc" : "asc";
      renderAll();
    });

    document.getElementById("output").addEventListener("click", e => {
      const th = e.target.closest("th[data-col]");
      if (!th) return;
      const col = th.dataset.col;
      if (sortCol === col) {
        sortDir = sortDir === "asc" ? "desc" : "asc";
      } else {
        sortCol = col;
        sortDir = col === "stars" ? "desc" : "asc";
      }
      // Sync the sort dropdown
      const sel = document.getElementById("sortSelect");
      for (const opt of sel.options) {
        if (opt.value === sortCol) { sel.value = sortCol; break; }
      }
      renderAll();
    });

    init();
  </script>
</body>
</html>
