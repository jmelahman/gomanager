<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GoManager ‚Äî Go Binary Repository</title>
  <style>
    /* Light mode (default) */
    :root {
      --bg: #f5f5f5;
      --bg-header: #fff;
      --bg-panel: #fff;
      --bg-input: #fff;
      --bg-hover: #eaeaea;
      --bg-btn: #e4e4e4;
      --bg-btn-hover: #d0d0d0;
      --text: #1a1a1a;
      --text-muted: #505050;
      --text-heading: #111;
      --link: #07b;
      --border: #ddd;
      --border-row: #eee;
      --border-input: #ccc;
      --confirmed: #1a6e1a;
      --failed: #b52020;
      --regressed: #a86000;
      --unknown: #707070;
      --flags: #8b2252;
      --cmd: #333;
      --copy-bg: #e4e4e4;
      --copy-border: #aaa;
      --copy-text: #505050;
      --copy-hover-bg: #d0d0d0;
      --copy-hover-text: #111;
      --arrow: #07b;
      --pagination-bold: #111;
      --save-bg: #1a6e1a;
      --edit-highlight: #fffbe6;
      --edit-border: #d4a800;
      --primary-icon: #888;
      --primary-icon-active: #d4a800;
    }
    /* Dark mode */
    html.dark {
      --bg: #1b1d1e;
      --bg-header: #222;
      --bg-panel: #222;
      --bg-input: #1b1d1e;
      --bg-hover: #2e3133;
      --bg-btn: #383838;
      --bg-btn-hover: #4a4a4a;
      --text: #ddd;
      --text-muted: #aaa;
      --text-heading: #f0f0f0;
      --link: #07b;
      --border: #333;
      --border-row: #2a2c2d;
      --border-input: #444;
      --confirmed: #5cb85c;
      --failed: #e05050;
      --regressed: #e8a030;
      --unknown: #888;
      --flags: #d8a0b0;
      --cmd: #ccc;
      --copy-bg: #383838;
      --copy-border: #555;
      --copy-text: #aaa;
      --copy-hover-bg: #4a4a4a;
      --copy-hover-text: #f0f0f0;
      --arrow: #07b;
      --pagination-bold: #f0f0f0;
      --save-bg: #2a7a2a;
      --edit-highlight: #3a3520;
      --edit-border: #8a7520;
      --primary-icon: #666;
      --primary-icon-active: #e8c547;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: sans-serif;
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    a { color: var(--link); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container {
      max-width: 1500px;
      margin: 0 auto;
      padding: 15px;
    }

    /* Header */
    .site-header {
      background: var(--bg-header);
      border-bottom: 1px solid var(--border);
      padding: 10px 0;
      margin-bottom: 15px;
    }
    .site-header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 0;
      padding-bottom: 0;
    }
    .site-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-heading);
    }
    .site-header h1 .site-title { color: var(--text-heading); text-decoration: none; }
    .site-header h1 .site-title:hover { text-decoration: none; opacity: 0.8; }
    .site-header h1 .site-title span { color: var(--link); }
    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .site-header .subtitle {
      color: var(--text-muted);
      font-size: 12px;
      margin-right: 8px;
    }
    .header-btn {
      background: var(--bg-btn);
      border: 1px solid var(--border-input);
      color: var(--text-muted);
      padding: 3px 10px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      border-radius: 3px;
    }
    .header-btn:hover { background: var(--bg-btn-hover); color: var(--text); }
    .header-btn.active {
      background: var(--link);
      color: #fff;
      border-color: var(--link);
    }

    /* Search Criteria box */
    .search-criteria {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      padding: 12px 15px;
      margin-bottom: 15px;
    }
    .search-criteria h2 {
      font-size: 14px;
      color: var(--text-heading);
      margin-bottom: 10px;
      font-weight: 600;
    }
    .search-row {
      display: flex;
      gap: 15px;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .search-field { display: flex; flex-direction: column; gap: 3px; }
    .search-field label { font-size: 11px; color: var(--text-muted); }
    .search-field input,
    .search-field select {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--border-input);
      padding: 4px 8px;
      font-size: 13px;
      font-family: inherit;
    }
    .search-field input { width: 260px; }
    .search-field select { min-width: 100px; }
    .search-field input:focus,
    .search-field select:focus { border-color: var(--link); outline: none; }
    .toggle-label {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
      padding-bottom: 2px;
    }
    .toggle-label input { cursor: pointer; }

    /* Results info */
    .results-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }
    .results-info .stats-inline span { margin-left: 10px; }
    .results-info .confirmed-count { color: var(--confirmed); }
    .results-info .failed-count { color: var(--failed); }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    thead { background: var(--bg-panel); }
    th {
      padding: 6px 10px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-input);
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
    }
    th:hover { color: var(--link); }
    th .arrow { font-size: 9px; margin-left: 3px; opacity: 0.4; }
    th.sorted .arrow { opacity: 1; color: var(--arrow); }
    td {
      padding: 4px 10px;
      border-bottom: 1px solid var(--border-row);
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      vertical-align: middle;
    }
    tr:hover td { background: var(--bg-hover); }
    /* Column widths */
    .col-name { width: 13%; }
    .col-version { width: 8%; }
    .col-stars { width: 6%; text-align: right; }
    .col-status { width: 7%; }
    .col-desc { width: 30%; }
    .col-install { width: 36%; }

    td.stars-cell { text-align: right; font-variant-numeric: tabular-nums; }
    td.name-cell a { color: var(--link); }
    td.desc-cell { color: var(--text-muted); }

    /* Status styles */
    .status-confirmed { color: var(--confirmed); }
    .status-failed { color: var(--failed); }
    .status-regressed { color: var(--regressed); }
    .status-unknown { color: var(--unknown); }

    /* Install column */
    td.install-cell {
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      font-size: 12px;
      white-space: nowrap;
    }
    td.install-cell .flags {
      color: var(--flags);
      margin-right: 2px;
    }
    td.install-cell .cmd { color: var(--cmd); }
    .copy-btn {
      background: var(--copy-bg);
      border: 1px solid var(--copy-border);
      color: var(--copy-text);
      padding: 1px 8px;
      margin-right: 6px;
      cursor: pointer;
      font-size: 11px;
      font-family: inherit;
      vertical-align: middle;
    }
    .copy-btn:hover { background: var(--copy-hover-bg); color: var(--copy-hover-text); }
    .copy-btn.copied { color: var(--confirmed); border-color: var(--confirmed); }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    .loading {
      text-align: center;
      padding: 60px;
      color: var(--text-muted);
    }

    /* Edit mode styles */
    .edit-mode .editable {
      cursor: pointer;
      border-bottom: 1px dashed var(--edit-border);
    }
    .edit-mode .editable:hover {
      background: var(--edit-highlight);
    }
    .edit-mode .primary-toggle {
      cursor: pointer;
      font-size: 11px;
      margin-left: 4px;
      opacity: 0.7;
    }
    .edit-mode .primary-toggle:hover { opacity: 1; }
    .primary-toggle { display: none; }
    .edit-mode .primary-toggle { display: inline; }

    /* Delete button in edit mode */
    .delete-btn {
      display: none;
      background: none;
      border: none;
      color: var(--failed);
      cursor: pointer;
      font-size: 13px;
      padding: 0 4px 0 0;
      vertical-align: middle;
      opacity: 0.5;
      line-height: 1;
    }
    .delete-btn:hover { opacity: 1; }
    .edit-mode .delete-btn { display: inline; }

    /* Inline edit input */
    .inline-edit {
      background: var(--bg-input);
      color: var(--text);
      border: 1px solid var(--edit-border);
      padding: 2px 6px;
      font-size: 12px;
      font-family: "SF Mono", "Fira Code", "Consolas", monospace;
      width: 100%;
      outline: none;
    }

    /* Save bar */
    .save-bar {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--save-bg);
      color: #fff;
      padding: 10px 20px;
      font-size: 13px;
      z-index: 100;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
    }
    .save-bar.visible { display: flex; }
    .save-bar .save-info { flex: 1; }
    .save-bar button {
      background: #fff;
      color: var(--save-bg);
      border: none;
      padding: 6px 20px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 3px;
      margin-left: 10px;
    }
    .save-bar button:hover { opacity: 0.9; }
    .save-bar .discard-btn {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.5);
    }

    @media (max-width: 900px) {
      .search-row { flex-direction: column; }
      .search-field input { width: 100%; }
      .col-desc { display: none; }
      .col-name { width: 18%; }
      .col-version { width: 10%; }
      .col-stars { width: 8%; }
      .col-status { width: 10%; }
      .col-install { width: 54%; }
    }
  </style>
</head>

<body>
  <div class="site-header">
    <div class="container">
      <div>
        <h1><a href="https://gomanager.dev" class="site-title">Go<span>Manager</span></a></h1>
      </div>
      <div class="header-right">
        <span class="subtitle">Go binary repository</span>
        <button class="header-btn" id="editToggle" title="Toggle edit mode">‚úèÔ∏è Edit</button>
        <button class="header-btn" id="themeToggle" title="Toggle dark mode">üåô Dark</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="search-criteria">
      <h2>Search Criteria</h2>
      <div class="search-row">
        <div class="search-field">
          <label>Keywords</label>
          <input type="text" id="search" placeholder="Search packages..." />
        </div>
        <div class="search-field">
          <label>Status</label>
          <select id="statusFilter">
            <option value="all">All</option>
            <option value="confirmed">Confirmed</option>
            <option value="failed">Failed</option>
            <option value="regressed">Regressed</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
        <div class="search-field">
          <label>Sort by</label>
          <select id="sortSelect">
            <option value="stars">Stars</option>
            <option value="name">Name</option>
            <option value="build_status">Status</option>
            <option value="version">Version</option>
          </select>
        </div>
        <div class="search-field">
          <label>Per page</label>
          <select id="perPage">
            <option value="50">50</option>
            <option value="100">100</option>
            <option value="250">250</option>
            <option value="0">All</option>
          </select>
        </div>
        <label class="toggle-label">
          <input type="checkbox" id="showAll" /> Show internal commands
        </label>
      </div>
    </div>

    <div class="results-info" id="resultsInfo"></div>
    <div id="output"><div class="loading">Loading database...</div></div>
    <div class="results-info" id="paginationBottom"></div>
  </div>

  <div class="save-bar" id="saveBar">
    <span class="save-info"><span id="changeCount">0</span> unsaved change(s)</span>
    <button class="discard-btn" onclick="discardChanges()">Discard</button>
    <button onclick="saveDatabase()">Save Database</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>
  <script>
    // Theme handling
    (function() {
      const saved = localStorage.getItem("theme");
      if (saved === "dark") {
        document.documentElement.classList.add("dark");
      }
      if (!saved && window.matchMedia("(prefers-color-scheme: dark)").matches) {
        document.documentElement.classList.add("dark");
      }
    })();

    function updateThemeButton() {
      const btn = document.getElementById("themeToggle");
      const isDark = document.documentElement.classList.contains("dark");
      btn.textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";
    }

    document.getElementById("themeToggle").addEventListener("click", () => {
      document.documentElement.classList.toggle("dark");
      const isDark = document.documentElement.classList.contains("dark");
      localStorage.setItem("theme", isDark ? "dark" : "light");
      updateThemeButton();
    });
    updateThemeButton();

    // State
    let db = null;
    let allRows = [];
    let sortCol = "stars";
    let sortDir = "desc";
    let currentPage = 1;
    let editMode = false;
    let pendingChanges = new Map(); // id -> { field: newValue, ... }
    let fileHandle = null; // for File System Access API

    // Edit mode toggle
    document.getElementById("editToggle").addEventListener("click", () => {
      editMode = !editMode;
      const btn = document.getElementById("editToggle");
      btn.classList.toggle("active", editMode);
      btn.textContent = editMode ? "‚úèÔ∏è Editing" : "‚úèÔ∏è Edit";
      document.body.classList.toggle("edit-mode", editMode);
      renderAll();
    });

    // Track changes
    function recordChange(id, field, value) {
      if (!pendingChanges.has(id)) pendingChanges.set(id, {});
      pendingChanges.get(id)[field] = value;
      updateSaveBar();
    }

    function updateSaveBar() {
      const bar = document.getElementById("saveBar");
      const count = pendingChanges.size;
      document.getElementById("changeCount").textContent = count;
      bar.classList.toggle("visible", count > 0);
    }

    function applyChangeToDb(id, field, value) {
      db.run(`UPDATE binaries SET ${field} = ? WHERE id = ?`, [value, id]);
      // Also update the in-memory allRows
      const row = allRows.find(r => r.id === id);
      if (row) row[field] = value;
    }

    function discardChanges() {
      // Reload data from the db (which still has original values for uncommitted changes)
      // Actually, we apply changes immediately to the in-memory db, so discard means re-fetch from file
      // Simpler: just reload the page
      if (confirm("Discard all unsaved changes? This will reload the database from disk.")) {
        pendingChanges.clear();
        updateSaveBar();
        location.reload();
      }
    }

    // Save database
    async function saveDatabase() {
      const data = db.export();
      const blob = new Blob([data], { type: "application/octet-stream" });

      // Try File System Access API first (Chrome/Edge on localhost)
      if (window.showSaveFilePicker) {
        try {
          if (!fileHandle) {
            fileHandle = await window.showSaveFilePicker({
              suggestedName: "database.db",
              types: [{ description: "SQLite Database", accept: { "application/octet-stream": [".db"] } }],
            });
          }
          const writable = await fileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          pendingChanges.clear();
          updateSaveBar();
          showToast("Database saved successfully!");
          return;
        } catch (err) {
          if (err.name === "AbortError") return; // user cancelled
          // Fall through to download
        }
      }

      // Fallback: download
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "database.db";
      a.click();
      URL.revokeObjectURL(url);
      pendingChanges.clear();
      updateSaveBar();
      showToast("Database downloaded. Replace your database.db with the downloaded file.");
    }

    function showToast(msg) {
      const el = document.createElement("div");
      el.textContent = msg;
      el.style.cssText = "position:fixed;top:15px;right:15px;background:var(--save-bg);color:#fff;padding:10px 18px;border-radius:4px;font-size:13px;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,0.3);";
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // Status cycling
    const STATUS_CYCLE = ["unknown", "confirmed", "failed", "regressed"];
    function cycleStatus(id, currentStatus) {
      const idx = STATUS_CYCLE.indexOf(currentStatus || "unknown");
      const next = STATUS_CYCLE[(idx + 1) % STATUS_CYCLE.length];
      applyChangeToDb(id, "build_status", next);
      recordChange(id, "build_status", next);
      renderAll();
    }

    // Delete entry
    function deleteEntry(id, name) {
      if (!confirm(`Delete "${name}" from the database?`)) return;
      db.run("DELETE FROM binaries WHERE id = ?", [id]);
      allRows = allRows.filter(r => r.id !== id);
      recordChange(id, "_deleted", true);
      renderAll();
    }

    // Primary toggle
    function togglePrimary(id, current) {
      const next = current ? 0 : 1;
      applyChangeToDb(id, "is_primary", next);
      recordChange(id, "is_primary", next);
      renderAll();
    }

    // Inline edit for flags
    function editFlags(td, id, currentFlags) {
      if (td.querySelector(".inline-edit")) return; // already editing
      const current = parseFlags(currentFlags);
      td.innerHTML = "";
      const input = document.createElement("input");
      input.className = "inline-edit";
      input.value = current;
      input.placeholder = "e.g. CGO_ENABLED=0";
      td.appendChild(input);
      input.focus();
      input.select();

      function commit() {
        const val = input.value.trim();
        // Convert "CGO_ENABLED=0 FOO=bar" to JSON {"CGO_ENABLED":"0","FOO":"bar"}
        let flagsJson = "{}";
        if (val) {
          const obj = {};
          val.split(/\s+/).forEach(pair => {
            const [k, ...rest] = pair.split("=");
            if (k) obj[k] = rest.join("=") || "1";
          });
          flagsJson = JSON.stringify(obj);
        }
        applyChangeToDb(id, "build_flags", flagsJson);
        recordChange(id, "build_flags", flagsJson);
        renderAll();
      }

      input.addEventListener("blur", commit);
      input.addEventListener("keydown", e => {
        if (e.key === "Enter") { e.preventDefault(); commit(); }
        if (e.key === "Escape") { renderAll(); }
      });
    }

    async function init() {
      try {
        const SQL = await initSqlJs({
          locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${f}`
        });
        const response = await fetch("./database.db");
        if (!response.ok) throw new Error("database.db not found");
        const buffer = await response.arrayBuffer();
        db = new SQL.Database(new Uint8Array(buffer));
        loadData();
      } catch (err) {
        document.getElementById("output").innerHTML =
          `<div class="empty-state">Failed to load database: ${err.message}</div>`;
      }
    }

    function loadData() {
      const result = db.exec(
        `SELECT id, name, package, version, description, repo_url, stars,
                COALESCE(is_primary, 1) as is_primary,
                build_status, build_flags, build_error, last_verified
         FROM binaries ORDER BY stars DESC`
      );
      if (!result.length) {
        allRows = [];
      } else {
        const cols = result[0].columns;
        allRows = result[0].values.map(row => {
          const obj = {};
          cols.forEach((c, i) => obj[c] = row[i]);
          return obj;
        });
      }
      renderAll();
    }

    function getFilteredRows() {
      const query = document.getElementById("search").value.toLowerCase();
      const showInternal = document.getElementById("showAll").checked;
      const statusFilter = document.getElementById("statusFilter").value;
      return allRows.filter(r => {
        if (!showInternal && !r.is_primary) return false;
        if (statusFilter !== "all") {
          if (statusFilter === "unknown" && r.build_status !== "unknown" && r.build_status !== "pending") return false;
          if (statusFilter === "regressed" && r.build_status !== "regressed") return false;
          if (statusFilter !== "unknown" && statusFilter !== "regressed" && r.build_status !== statusFilter) return false;
        }
        if (query) {
          const hay = `${r.name} ${r.package} ${r.description || ""}`.toLowerCase();
          return hay.includes(query);
        }
        return true;
      });
    }

    function sortRows(rows) {
      return rows.slice().sort((a, b) => {
        let va = a[sortCol], vb = b[sortCol];
        if (typeof va === "string") va = (va || "").toLowerCase();
        if (typeof vb === "string") vb = (vb || "").toLowerCase();
        if (va == null) va = "";
        if (vb == null) vb = "";
        let cmp = 0;
        if (typeof va === "number" && typeof vb === "number") cmp = va - vb;
        else cmp = String(va).localeCompare(String(vb));
        return sortDir === "asc" ? cmp : -cmp;
      });
    }

    function getPerPage() {
      return parseInt(document.getElementById("perPage").value) || 0;
    }

    function renderAll() {
      const filtered = sortRows(getFilteredRows());
      const total = filtered.length;
      const perPage = getPerPage();
      const totalPages = perPage > 0 ? Math.ceil(total / perPage) : 1;
      if (currentPage > totalPages) currentPage = totalPages || 1;

      const start = perPage > 0 ? (currentPage - 1) * perPage : 0;
      const pageRows = perPage > 0 ? filtered.slice(start, start + perPage) : filtered;

      // Stats
      const confirmed = filtered.filter(r => r.build_status === "confirmed").length;
      const failed = filtered.filter(r => r.build_status === "failed").length;
      const regressed = filtered.filter(r => r.build_status === "regressed").length;

      const pageInfo = perPage > 0
        ? `${total} packages found. Page ${currentPage} of ${totalPages}.`
        : `${total} packages found.`;

      let statsHtml =
        `<span class="confirmed-count">${confirmed} confirmed</span>` +
        `<span class="failed-count">${failed} failed</span>`;
      if (regressed > 0) {
        statsHtml += `<span style="color:var(--regressed)">${regressed} regressed</span>`;
      }

      document.getElementById("resultsInfo").innerHTML =
        `<div>${pageInfo}</div>` +
        `<div class="stats-inline">${statsHtml}</div>`;

      // Pagination
      let paginationHtml = "";
      if (perPage > 0 && totalPages > 1) {
        paginationHtml = renderPagination(currentPage, totalPages);
      }
      document.getElementById("paginationBottom").innerHTML = paginationHtml;

      // Table
      if (!pageRows.length) {
        document.getElementById("output").innerHTML =
          `<div class="empty-state">No packages found.</div>`;
        return;
      }

      const columns = [
        { key: "name", label: "Name", cls: "col-name" },
        { key: "version", label: "Version", cls: "col-version" },
        { key: "stars", label: "Stars", cls: "col-stars" },
        { key: "build_status", label: "Status", cls: "col-status" },
        { key: "description", label: "Description", cls: "col-desc" },
        { key: "package", label: "Install", cls: "col-install", nosort: true },
      ];

      let html = "<table><thead><tr>";
      for (const col of columns) {
        const sorted = sortCol === col.key;
        const arrow = sorted ? (sortDir === "asc" ? "&#9650;" : "&#9660;") : "";
        const sortable = !col.nosort;
        html += `<th class="${col.cls} ${sorted ? "sorted" : ""}" ${sortable ? `data-col="${col.key}"` : ""}>${col.label}${arrow ? `<span class="arrow">${arrow}</span>` : ""}</th>`;
      }
      html += "</tr></thead><tbody>";

      for (const r of pageRows) {
        const statusCls = r.build_status === "confirmed" ? "status-confirmed"
          : r.build_status === "failed" ? "status-failed"
          : r.build_status === "regressed" ? "status-regressed" : "status-unknown";
        const flags = parseFlags(r.build_flags);
        const installPkg = `go install ${r.package}@${r.version || "latest"}`;
        const fullCmd = flags ? flags + " " + installPkg : installPkg;
        const dirty = pendingChanges.has(r.id);
        const primaryIcon = r.is_primary ? "‚òÖ" : "‚òÜ";
        const primaryColor = r.is_primary ? "var(--primary-icon-active)" : "var(--primary-icon)";

        html += "<tr>";

        // Name + primary toggle + delete
        html += `<td class="name-cell col-name">`;
        html += `<button class="delete-btn" onclick="deleteEntry(${r.id},'${escAttr(r.name)}')" title="Delete entry">‚úï</button>`;
        html += `<a href="${r.repo_url || "#"}" target="_blank" rel="noopener">${esc(r.name)}</a>`;
        html += `<span class="primary-toggle" style="color:${primaryColor}" onclick="togglePrimary(${r.id},${r.is_primary})" title="${r.is_primary ? "Primary (click to unmark)" : "Not primary (click to mark)"}">${primaryIcon}</span>`;
        html += `</td>`;

        html += `<td class="col-version">${esc(r.version || "latest")}</td>`;
        html += `<td class="stars-cell col-stars">${(r.stars || 0).toLocaleString()}</td>`;

        // Status (clickable in edit mode)
        if (editMode) {
          html += `<td class="col-status editable ${statusCls}" onclick="cycleStatus(${r.id},'${r.build_status || "unknown"}')" title="Click to cycle status">${r.build_status || "unknown"}</td>`;
        } else {
          html += `<td class="col-status ${statusCls}">${r.build_status || "unknown"}</td>`;
        }

        html += `<td class="desc-cell col-desc" title="${esc(r.description || "")}">${esc(r.description || "")}</td>`;

        // Install (flags editable in edit mode)
        html += `<td class="install-cell col-install" data-id="${r.id}" data-flags='${esc(r.build_flags || "{}")}'>`;
        html += `<button class="copy-btn" onclick="copyCmd(this,'${escAttr(fullCmd)}')">Copy</button> `;
        if (editMode) {
          html += `<span class="editable flags-edit" onclick="editFlags(this.closest('td'),${r.id},'${escAttr(r.build_flags || "{}") }')" title="Click to edit flags">`;
          html += flags ? `<span class="flags">${esc(flags)}</span>` : `<span style="color:var(--text-muted);font-style:italic">+flags</span>`;
          html += `</span> `;
        } else {
          if (flags) html += `<span class="flags">${esc(flags)}</span> `;
        }
        html += `<span class="cmd">${esc(installPkg)}</span>`;
        html += `</td>`;

        html += "</tr>";
      }

      html += "</tbody></table>";
      document.getElementById("output").innerHTML = html;
    }

    function renderPagination(current, total) {
      let html = '<div style="margin-top:8px;font-size:12px;">';
      const pages = [];

      pages.push(1);
      let start = Math.max(2, current - 2);
      let end = Math.min(total - 1, current + 2);
      if (start > 2) pages.push("...");
      for (let i = start; i <= end; i++) pages.push(i);
      if (end < total - 1) pages.push("...");
      if (total > 1) pages.push(total);

      if (current > 1) html += `<a href="#" onclick="goPage(${current-1});return false">Prev</a> `;
      for (const p of pages) {
        if (p === "...") { html += ".. "; continue; }
        if (p === current) html += `<b style="color:var(--pagination-bold)">${p}</b> `;
        else html += `<a href="#" onclick="goPage(${p});return false">${p}</a> `;
      }
      if (current < total) html += `<a href="#" onclick="goPage(${current+1});return false">Next</a>`;
      html += "</div>";
      return html;
    }

    function goPage(n) { currentPage = n; renderAll(); window.scrollTo(0, 0); }

    function parseFlags(flagsJson) {
      if (!flagsJson || flagsJson === "{}") return "";
      try {
        const obj = JSON.parse(flagsJson);
        return Object.entries(obj).map(([k, v]) => `${k}=${v}`).join(" ");
      } catch { return ""; }
    }

    function esc(str) {
      if (!str) return "";
      const div = document.createElement("div");
      div.textContent = str;
      return div.innerHTML;
    }

    function escAttr(str) {
      return esc(str).replace(/'/g, "\\'");
    }

    function copyCmd(btn, cmd) {
      navigator.clipboard.writeText(cmd).then(() => {
        btn.textContent = "Copied!";
        setTimeout(() => { btn.textContent = "Copy"; }, 1200);
      });
    }

    // Event listeners
    document.getElementById("search").addEventListener("input", () => { currentPage = 1; renderAll(); });
    document.getElementById("statusFilter").addEventListener("change", () => { currentPage = 1; renderAll(); });
    document.getElementById("showAll").addEventListener("change", () => { currentPage = 1; renderAll(); });
    document.getElementById("perPage").addEventListener("change", () => { currentPage = 1; renderAll(); });
    document.getElementById("sortSelect").addEventListener("change", e => {
      sortCol = e.target.value;
      sortDir = sortCol === "stars" ? "desc" : "asc";
      renderAll();
    });

    document.getElementById("output").addEventListener("click", e => {
      const th = e.target.closest("th[data-col]");
      if (!th) return;
      const col = th.dataset.col;
      if (sortCol === col) {
        sortDir = sortDir === "asc" ? "desc" : "asc";
      } else {
        sortCol = col;
        sortDir = col === "stars" ? "desc" : "asc";
      }
      const sel = document.getElementById("sortSelect");
      for (const opt of sel.options) {
        if (opt.value === sortCol) { sel.value = sortCol; break; }
      }
      renderAll();
    });

    // Warn on navigation with unsaved changes
    window.addEventListener("beforeunload", e => {
      if (pendingChanges.size > 0) {
        e.preventDefault();
        e.returnValue = "";
      }
    });

    init();
  </script>
</body>
</html>
