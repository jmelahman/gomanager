name: Verify Go Builds

on:
  schedule:
    # Run weekly on Sundays at 08:00 UTC
    - cron: "0 8 * * 0"
  workflow_dispatch:
    inputs:
      batch_size:
        description: "Number of packages to verify per run"
        required: false
        default: "50"
      reverify:
        description: "Also re-verify previously failed packages"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd

      - uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5
        with:
          go-version: stable

      - name: Verify builds
        run: |
          ARGS="--database ./database.db -n ${{ github.event.inputs.batch_size || '50' }}"
          if [ "${{ github.event.inputs.reverify }}" = "true" ]; then
            ARGS="$ARGS --reverify"
          fi
          go run ./cmd/gomanager-admin verify $ARGS

      - name: Commit verification results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add database.db
          git diff --cached --quiet || git commit -m "chore: update build verification results [skip ci]"
          git push
